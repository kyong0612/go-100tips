# 20230902

## init関数の誤用

- init関数は、アプリケーションの状態を初期化するために使われる
- パッケージが初期化される際に、パッケージ内のすべての定数と変数宣言が評価される
- 1つのパッケージに対して複数のinit関数を定義できる
- その場合、パッケージ内のinit関数の実行順序は、ソースファイルのアルファベット順になる

## init関数を使うべき場合

- 不適切な例

```go

func init() {
 dataSourceName := os.Getenv("MYSQL_DATA_SOURCE_NAME") // ←環境変数
 d, err := sql.Open("mysql", dataSourceName)
 if err != nil {
  log.Panic(err)
 }
 err = d.Ping()
 if err != nil {
  log.Panic(err)
 }
 db = d // ← DBコネクションをグローバルのdb変数へ代入
}

```

- 3つの主な欠点
    1. init関数内のエラー管理は限られている
  　　- エラーを通知する方法とpanicを起こすだけだが、packageがapplicationの停止させるかどうかを決めるのは、必ずしもぱケージ時間であるべきではない
    2. テストを実行する際にかならずinit関数がよばれてしまう
    3. データベース・コネクション・プールをグローバル変数に代入する必要がること
      - グローバル変数の重大な欠点
        - どの関数でもパッケージ内のグローバル変数を変更できる
        - グローバル変数に依存する関数は切り離されないので、単体テストは複雑になるかのうせいがある
